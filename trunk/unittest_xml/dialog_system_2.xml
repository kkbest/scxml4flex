<?xml version="1.0"?>
<scxml initial="root">

	<datamodel>
		<data id="grammar">
		<![CDATA[
		#JSGF V1.0;
		grammar factorial;
		public <top> = quit | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9;
		]]>	
		</data>
	</datamodel>
	<state id="root">
		<invoke id="tts" type="x-tts" />
		<invoke id="asr" type="x-asr" />
		<invoke id="fac" type="scxml">
			<content>
				<scxml initial="waiting" >
					<datamodel>
						<data id="fac"/>
					</datamodel>
					
					<state id="waiting">
						<onentry>
							<assign location="fac" expr="1" />
						</onentry>
						<transition event="calc" target="loop">
							<assign location="x" expr="dm['_event'].data.val" />
						</transition>
					</state>
					  
					<state id="loop">
				        <transition cond="dm['x'] &gt; 1">
							<assign location="fac" expr="dm['x'] * dm['fac']"/>
							<assign location="x" expr="dm['x']-1"/>
						</transition>
						<transition target="waiting">
					   		<send event="calc_result" target="#_parent">
					   			<param name="val" expr="dm['fac']" />
					   		</send>
							
						</transition>
				    </state>
				</scxml>
			</content>
		</invoke>

		<transition event="init.invoke.tts">
			<log label="testing" />
		</transition>
		
		<state id="init">
			<transition event="init.invoke.tts" target="query" />
		</state>
		
		
		<state id="query">
			<onentry>
				<send type="x-tts" target="#tts" >
					<param name="say" expr="'Welcome. Please say a number between one and nine.'" />
				</send>
			</onentry>
			
			<transition event="result.invoke.tts">
				<send type="x-asr" target="#asr">
					<param name="grammar" expr="dm['grammar']" />
				</send>
			</transition>
			
			<transition event="result.invoke.asr.quit" target="f2" />
			
			<transition event="result.invoke.asr.*">
				<send event="calc" target="#fac">
					<param name="val" expr="parseInt(dm['asr'].lastResult)" />
				</send>
			</transition>

			<transition event="calc_result" target="report_result" />
		</state>
		
		<state id="report_result">
			<onentry>
				<log label="fac result" expr="dm['_event'].data.val" />
				<send type="x-tts" target="#tts">
					<param name="say" expr="'The factorial of ' + dm['asr'].lastResult + ' is ' + dm['_event'].data.val + '. Please say another number.'" />
				</send>
			</onentry>
			
			<transition event="result.invoke.tts" target="query" /> 
			
		</state>
	
	</state>
	<final id="f2"/>
</scxml>

